<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ITAM | Inventário de TI</title>
    <!-- Fontes e Ícones -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&family=JetBrains+Mono:wght@400;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-deep: #020617;
            --bg-card: #0f172a;
            --primary: #38bdf8;
            --primary-glow: rgba(56, 189, 248, 0.3);
            --secondary: #6366f1;
            --accent: #f472b6;
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
            --text-main: #f1f5f9;
            --text-dim: #94a3b8;
            --border: #1e293b;
            --sidebar-width: 260px;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Inter', sans-serif;
            scrollbar-width: thin;
            scrollbar-color: var(--border) var(--bg-deep);
        }

        body {
            background-color: var(--bg-deep);
            color: var(--text-main);
            overflow-x: hidden;
            min-height: 100vh;
        }

        /* Layout Estrutural */
        .app-wrapper {
            display: flex;
            min-height: 100vh;
        }

        /* Sidebar Futurista */
        aside.sidebar {
            width: var(--sidebar-width);
            background: var(--bg-card);
            border-right: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            position: fixed;
            height: 100vh;
            z-index: 100;
            transition: transform 0.3s ease;
        }

        .logo-area {
            padding: 2rem;
            text-align: center;
            border-bottom: 1px solid var(--border);
        }

        .logo-area h1 {
            font-family: 'JetBrains Mono', monospace;
            font-size: 1.5rem;
            color: var(--primary);
            letter-spacing: -1px;
            text-shadow: 0 0 10px var(--primary-glow);
        }

        .nav-links {
            padding: 1rem;
            flex-grow: 1;
        }

        .nav-item {
            display: flex;
            align-items: center;
            padding: 12px 16px;
            margin-bottom: 8px;
            border-radius: 12px;
            cursor: pointer;
            color: var(--text-dim);
            transition: all 0.2s;
            font-weight: 500;
        }

        .nav-item:hover {
            background: rgba(56, 189, 248, 0.05);
            color: var(--primary);
        }

        .nav-item.active {
            background: var(--primary);
            color: var(--bg-deep);
            box-shadow: 0 0 20px var(--primary-glow);
        }

        .nav-item svg {
            margin-right: 12px;
            width: 20px;
        }

        /* Área Principal */
        main.content {
            flex-grow: 1;
            margin-left: var(--sidebar-width);
            padding: 2rem;
            max-width: calc(100vw - var(--sidebar-width));
        }

        header.top-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
        }

        .search-container {
            position: relative;
            width: 400px;
        }

        .search-container input {
            width: 100%;
            background: var(--bg-card);
            border: 1px solid var(--border);
            padding: 12px 12px 12px 40px;
            border-radius: 10px;
            color: white;
            transition: border-color 0.3s;
        }

        .search-container input:focus {
            outline: none;
            border-color: var(--primary);
        }

        .search-container svg {
            position: absolute;
            left: 12px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--text-dim);
        }

        /* Dashboard Stats */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2.5rem;
        }

        .stat-card {
            background: var(--bg-card);
            padding: 1.5rem;
            border-radius: 16px;
            border: 1px solid var(--border);
            position: relative;
            overflow: hidden;
        }

        .stat-card::after {
            content: '';
            position: absolute;
            top: 0; right: 0;
            width: 40px; height: 40px;
            background: linear-gradient(135deg, transparent 50%, rgba(255,255,255,0.05) 50%);
        }

        .stat-value {
            font-size: 2rem;
            font-weight: 700;
            color: var(--primary);
            margin-top: 0.5rem;
        }

        .stat-label {
            color: var(--text-dim);
            font-size: 0.85rem;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        /* Tabelas Futuristas */
        .card-table {
            background: var(--bg-card);
            border-radius: 16px;
            border: 1px solid var(--border);
            padding: 1.5rem;
        }

        .table-responsive {
            overflow-x: auto;
            margin-top: 1rem;
        }

        table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0 8px;
        }

        th {
            text-align: left;
            padding: 12px;
            color: var(--text-dim);
            font-weight: 600;
            text-transform: uppercase;
            font-size: 0.75rem;
        }

        td {
            padding: 16px 12px;
            background: rgba(255,255,255,0.02);
            border-top: 1px solid var(--border);
            border-bottom: 1px solid var(--border);
        }

        td:first-child { border-left: 1px solid var(--border); border-radius: 10px 0 0 10px; }
        td:last-child { border-right: 1px solid var(--border); border-radius: 0 10px 10px 0; }

        tr:hover td {
            background: rgba(56, 189, 248, 0.05);
            border-color: rgba(56, 189, 248, 0.2);
        }

        /* Badges e Status */
        .badge {
            padding: 4px 10px;
            border-radius: 6px;
            font-size: 0.75rem;
            font-weight: 700;
            display: inline-flex;
            align-items: center;
        }

        .badge-success { background: rgba(16, 185, 129, 0.1); color: var(--success); }
        .badge-warning { background: rgba(245, 158, 11, 0.1); color: var(--warning); }
        .badge-danger { background: rgba(239, 68, 68, 0.1); color: var(--danger); }
        .badge-info { background: rgba(56, 189, 248, 0.1); color: var(--primary); }

        /* Formulários */
        .form-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 1.5rem;
        }

        .form-group {
            margin-bottom: 1.25rem;
        }

        .full-width { grid-column: span 2; }

        label {
            display: block;
            margin-bottom: 8px;
            font-size: 0.9rem;
            color: var(--text-dim);
        }

        input, select, textarea {
            width: 100%;
            background: var(--bg-deep);
            border: 1px solid var(--border);
            padding: 12px;
            border-radius: 8px;
            color: white;
            font-size: 0.95rem;
        }

        button.btn {
            padding: 12px 24px;
            border-radius: 8px;
            border: none;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .btn-primary { background: var(--primary); color: var(--bg-deep); }
        .btn-primary:hover { box-shadow: 0 0 15px var(--primary-glow); transform: translateY(-1px); }
        
        /* Modal Custom */
        #modal-overlay {
            position: fixed;
            inset: 0;
            background: rgba(2, 6, 23, 0.85);
            backdrop-filter: blur(8px);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            padding: 20px;
        }

        #modal-card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            width: 100%;
            max-width: 500px;
            border-radius: 20px;
            padding: 2rem;
            box-shadow: 0 25px 50px -12px rgba(0,0,0,0.5);
        }

        /* Responsividade Extrema */
        @media (max-width: 1024px) {
            aside.sidebar { width: 80px; }
            .logo-area h1, .nav-item span { display: none; }
            main.content { margin-left: 80px; max-width: calc(100vw - 80px); }
            .search-container { width: 100%; }
        }

        @media (max-width: 768px) {
            aside.sidebar {
                top: auto;
                bottom: 0;
                width: 100%;
                height: 70px;
                flex-direction: row;
                border-right: none;
                border-top: 1px solid var(--border);
            }
            .logo-area { display: none; }
            .nav-links { display: flex; justify-content: space-around; width: 100%; padding: 0; }
            .nav-item { flex-direction: column; margin: 0; font-size: 0.6rem; padding: 10px; }
            .nav-item svg { margin: 0 0 4px 0; }
            main.content { margin-left: 0; padding: 1rem; padding-bottom: 90px; max-width: 100vw; }
            header.top-bar { flex-direction: column; gap: 1rem; }
            .form-grid { grid-template-columns: 1fr; }
            .full-width { grid-column: auto; }
            .stats-grid { grid-template-columns: 1fr 1fr; }
        }
    </style>
</head>
<body>

<div class="app-wrapper">
    <!-- Navegação Sidebar -->
    <aside class="sidebar">
        <div class="logo-area">
            <h1>ITAM</h1>
        </div>
        <nav class="nav-links">
            <div class="nav-item active" onclick="switchTab('dashboard')">
                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2V6zM14 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2V6zM4 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2v-2zM14 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2v-2z"></path></svg>
                <span>Dashboard</span>
            </div>
            <div class="nav-item" onclick="switchTab('inventory')">
                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 13V6a2 2 0 00-2-2H6a2 2 0 00-2 2v7m16 0v5a2 2 0 01-2 2H6a2 2 0 01-2-2v-5m16 0h-2.586a1 1 0 00-.707.293l-2.414 2.414a1 1 0 01-.707.293h-3.172a1 1 0 01-.707-.293l-2.414-2.414A1 1 0 006.586 13H4"></path></svg>
                <span>Inventário</span>
            </div>
            <div class="nav-item" onclick="switchTab('movement')">
                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7h12m0 0l-4-4m4 4l-4 4m0 6H4m0 0l4 4m-4-4l4-4"></path></svg>
                <span>Saída/Entrada</span>
            </div>
            <div class="nav-item" onclick="switchTab('history')">
                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                <span>Histórico</span>
            </div>
        </nav>
    </aside>

    <!-- Conteúdo Principal -->
    <main class="content">
        <header class="top-bar">
            <div>
                <h2 id="view-title">Dashboard Operacional</h2>
                <p style="color: var(--text-dim); font-size: 0.8rem;" id="current-date"></p>
            </div>
            <div class="search-container">
                <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg>
                <input type="text" id="global-search" placeholder="Buscar por série, modelo ou usuário..." oninput="handleSearch(this.value)">
            </div>
        </header>

        <!-- DASHBOARD TAB -->
        <div id="dashboard-tab">
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-label">Total Ativos</div>
                    <div class="stat-value" id="stat-total">0</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Em Operação</div>
                    <div class="stat-value" id="stat-in-use">0</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Em Manutenção</div>
                    <div class="stat-value" id="stat-maintenance">0</div>
                </div>
                <div class="stat-card" style="border-left: 4px solid var(--danger);">
                    <div class="stat-label">Devoluções Atrasadas</div>
                    <div class="stat-value" id="stat-overdue">0</div>
                </div>
            </div>

            <div class="card-table">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                    <h3>Equipamentos Recentes</h3>
                    <button class="btn btn-primary" onclick="switchTab('inventory')">Ver Todos</button>
                </div>
                <div class="table-responsive">
                    <table id="recent-table">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Equipamento</th>
                                <th>Série</th>
                                <th>Status</th>
                                <th>Local/Responsável</th>
                            </tr>
                        </thead>
                        <tbody id="dashboard-body"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- INVENTORY TAB -->
        <div id="inventory-tab" style="display:none;">
            <div class="card-table">
                <div style="display:flex; justify-content: space-between; align-items:center; margin-bottom: 2rem; flex-wrap: wrap; gap: 15px;">
                    <h3>Gestão de Inventário</h3>
                    <div style="display:flex; gap: 8px;">
                        <input type="file" id="csv-upload" accept=".csv" style="display: none;" onchange="importCSV(this)">
                        <button class="btn" style="background: var(--secondary); color: white;" onclick="document.getElementById('csv-upload').click()">Importar CSV</button>
                        <button class="btn btn-primary" onclick="openAddModal()">+ Novo Item</button>
                        <button class="btn" style="background: var(--border);" onclick="exportInventory()">Exportar CSV</button>
                    </div>
                </div>
                <div class="table-responsive">
                    <table>
                        <thead>
                            <tr>
                                <th>Patrimônio</th>
                                <th>Tipo/Modelo</th>
                                <th>Série</th>
                                <th>Status</th>
                                <th>Local/Resp.</th>
                                <th>Ações</th>
                            </tr>
                        </thead>
                        <tbody id="inventory-body"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- MOVEMENT TAB -->
        <div id="movement-tab" style="display:none;">
            <div class="form-grid">
                <!-- Saída -->
                <div class="card-table">
                    <h3>Registrar Saída (Checkout)</h3>
                    <form id="checkout-form" style="margin-top: 1.5rem;">
                        <div class="form-group">
                            <label>Equipamento Disponível</label>
                            <select id="co-equipment" required></select>
                        </div>
                        <div class="form-group">
                            <label>Colaborador / Destino</label>
                            <input type="text" id="co-user" placeholder="Nome completo" required>
                        </div>
                        <div class="form-group">
                            <label>Data Limite de Retorno</label>
                            <input type="date" id="co-deadline" required>
                        </div>
                        <button type="submit" class="btn btn-primary" style="width: 100%;">Liberar Equipamento</button>
                    </form>
                </div>

                <!-- Entrada -->
                <div class="card-table">
                    <h3>Registrar Retorno (Check-in)</h3>
                    <form id="checkin-form" style="margin-top: 1.5rem;">
                        <div class="form-group">
                            <label>Equipamento em Uso</label>
                            <select id="ci-equipment" required></select>
                        </div>
                        <div class="form-group">
                            <label>Condição no Retorno</label>
                            <select id="ci-condition">
                                <option value="Excelente">Excelente</option>
                                <option value="Boa">Boa</option>
                                <option value="Necessita Reparo">Necessita Reparo</option>
                                <option value="Danificado">Danificado</option>
                            </select>
                        </div>
                        <button type="submit" class="btn btn-primary" style="width: 100%; background: var(--success);">Confirmar Recebimento</button>
                    </form>
                </div>
            </div>
        </div>

        <!-- HISTORY TAB -->
        <div id="history-tab" style="display:none;">
            <div class="card-table">
                <h3>Log de Atividades do Sistema</h3>
                <div class="table-responsive">
                    <table>
                        <thead>
                            <tr>
                                <th>Timestamp</th>
                                <th>Ativo</th>
                                <th>Evento</th>
                                <th>Agente</th>
                                <th>Notas</th>
                            </tr>
                        </thead>
                        <tbody id="history-body"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </main>
</div>

<!-- Modal para Adicionar/Editar -->
<div id="modal-overlay">
    <div id="modal-card">
        <h3 id="modal-title" style="margin-bottom: 1.5rem;">Novo Ativo de TI</h3>
        <form id="equipment-form">
            <input type="hidden" id="eq-id">
            <div class="form-grid">
                <div class="form-group">
                    <label>Tipo</label>
                    <select id="eq-type" required>
                        <option value="Notebook">Notebook</option>
                        <option value="Monitor">Monitor</option>
                        <option value="Smartphone">Smartphone</option>
                        <option value="Desktop">Desktop</option>
                        <option value="Periférico">Periférico</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Modelo</label>
                    <input type="text" id="eq-model" required>
                </div>
                <div class="form-group">
                    <label>Número de Série</label>
                    <input type="text" id="eq-serial" required>
                </div>
                <div class="form-group">
                    <label>Status</label>
                    <select id="eq-status">
                        <option value="Disponível">Disponível</option>
                        <option value="Em Uso">Em Uso</option>
                        <option value="Manutenção">Manutenção</option>
                    </select>
                </div>
                <div class="form-group full-width">
                    <label>Local / Responsável Atual</label>
                    <input type="text" id="eq-user" placeholder="Ex: Almoxarifado ou Nome do Usuário">
                </div>
            </div>
            <div style="display:flex; gap: 10px; margin-top: 2rem;">
                <button type="button" class="btn" style="flex:1; background: var(--border);" onclick="closeModal()">Cancelar</button>
                <button type="submit" class="btn btn-primary" style="flex:2;">Salvar no Sistema</button>
            </div>
        </form>
    </div>
</div>

<script>
    // Gerenciamento de Estado
    let assets = JSON.parse(localStorage.getItem('erp_assets')) || [];
    let logs = JSON.parse(localStorage.getItem('erp_logs')) || [];

    window.onload = () => {
        document.getElementById('current-date').innerText = new Intl.DateTimeFormat('pt-BR', { dateStyle: 'full' }).format(new Date());
        refreshUI();
    };

    function saveData() {
        localStorage.setItem('erp_assets', JSON.stringify(assets));
        localStorage.setItem('erp_logs', JSON.stringify(logs));
        refreshUI();
    }

    function switchTab(tabName) {
        const tabs = ['dashboard', 'inventory', 'movement', 'history'];
        tabs.forEach(t => {
            document.getElementById(${t}-tab).style.display = t === tabName ? 'block' : 'none';
        });

        document.querySelectorAll('.nav-item').forEach(item => {
            item.classList.remove('active');
            if(item.innerText.toLowerCase().includes(tabName.substring(0,3))) item.classList.add('active');
        });

        document.getElementById('view-title').innerText = tabName.charAt(0).toUpperCase() + tabName.slice(1);
    }

    function refreshUI() {
        renderDashboard();
        renderInventory();
        renderHistory();
        updateStats();
        populateSelects();
    }

    function updateStats() {
        document.getElementById('stat-total').innerText = assets.length;
        document.getElementById('stat-in-use').innerText = assets.filter(a => a.status === 'Em Uso').length;
        document.getElementById('stat-maintenance').innerText = assets.filter(a => a.status === 'Manutenção').length;
        const overdueCount = assets.filter(a => a.deadline && new Date(a.deadline) < new Date() && a.status === 'Em Uso').length;
        document.getElementById('stat-overdue').innerText = overdueCount;
    }

    function renderDashboard() {
        const body = document.getElementById('dashboard-body');
        body.innerHTML = '';
        assets.slice(-5).reverse().forEach(a => {
            body.innerHTML += `
                <tr>
                    <td><span style="font-family: monospace; color: var(--primary)">#${a.id.substring(0,6)}</span></td>
                    <td>${a.type} ${a.model}</td>
                    <td>${a.serial}</td>
                    <td><span class="badge ${getStatusClass(a.status)}">${a.status}</span></td>
                    <td>${a.user || 'Estoque Central'}</td>
                </tr>
            `;
        });
    }

    function renderInventory(filter = '') {
        const body = document.getElementById('inventory-body');
        body.innerHTML = '';
        
        const filtered = assets.filter(a => 
            a.serial.toLowerCase().includes(filter.toLowerCase()) || 
            a.model.toLowerCase().includes(filter.toLowerCase()) ||
            (a.user && a.user.toLowerCase().includes(filter.toLowerCase()))
        );

        filtered.forEach(a => {
            body.innerHTML += `
                <tr>
                    <td>${a.id.substring(0,8)}</td>
                    <td><b>${a.type}</b><br><small>${a.model}</small></td>
                    <td><code style="color: var(--primary)">${a.serial}</code></td>
                    <td><span class="badge ${getStatusClass(a.status)}">${a.status}</span></td>
                    <td><small>${a.user || 'ESTOQUE'}</small></td>
                    <td>
                        <div style="display: flex; gap: 5px;">
                            <button class="btn" style="padding: 5px 8px; font-size: 0.7rem; background: var(--border)" onclick="openEditModal('${a.id}')">Editar</button>
                            <button class="btn" style="padding: 5px 8px; font-size: 0.7rem; background: rgba(239, 68, 68, 0.2); color: var(--danger)" onclick="deleteAsset('${a.id}')">Excluir</button>
                        </div>
                    </td>
                </tr>
            `;
        });
    }

    function renderHistory() {
        const body = document.getElementById('history-body');
        body.innerHTML = '';
        logs.slice().reverse().forEach(l => {
            body.innerHTML += `
                <tr>
                    <td style="font-size: 0.8rem; color: var(--text-dim)">${new Date(l.date).toLocaleString()}</td>
                    <td>${l.assetId.substring(0,8)}</td>
                    <td><span class="badge badge-info">${l.event}</span></td>
                    <td>${l.agent}</td>
                    <td style="font-size: 0.8rem">${l.notes}</td>
                </tr>
            `;
        });
    }

    function getStatusClass(status) {
        switch(status) {
            case 'Disponível': return 'badge-success';
            case 'Em Uso': return 'badge-info';
            case 'Manutenção': return 'badge-warning';
            default: return '';
        }
    }

    // Modal Add/Edit
    function openAddModal() {
        document.getElementById('modal-title').innerText = 'Novo Ativo de TI';
        document.getElementById('eq-id').value = '';
        document.getElementById('equipment-form').reset();
        document.getElementById('modal-overlay').style.display = 'flex';
    }

    function openEditModal(id) {
        const asset = assets.find(a => a.id === id);
        if(!asset) return;

        document.getElementById('modal-title').innerText = 'Editar Ativo';
        document.getElementById('eq-id').value = asset.id;
        document.getElementById('eq-type').value = asset.type;
        document.getElementById('eq-model').value = asset.model;
        document.getElementById('eq-serial').value = asset.serial;
        document.getElementById('eq-status').value = asset.status;
        document.getElementById('eq-user').value = asset.user || '';
        
        document.getElementById('modal-overlay').style.display = 'flex';
    }

    function closeModal() { document.getElementById('modal-overlay').style.display = 'none'; }

    // Submit Formulário Ativo
    document.getElementById('equipment-form').onsubmit = (e) => {
        e.preventDefault();
        const id = document.getElementById('eq-id').value;
        const type = document.getElementById('eq-type').value;
        const model = document.getElementById('eq-model').value;
        const serial = document.getElementById('eq-serial').value;
        const status = document.getElementById('eq-status').value;
        const user = document.getElementById('eq-user').value;

        if(id) {
            // Edit
            const index = assets.findIndex(a => a.id === id);
            assets[index] = { ...assets[index], type, model, serial, status, user };
            addLog(id, 'Edição', 'Admin', Dados alterados manualmente. Status: ${status}, Local: ${user});
        } else {
            // New
            const newId = 'ASSET-' + Math.random().toString(36).substr(2, 9).toUpperCase();
            assets.push({
                id: newId, type, model, serial, status, user,
                condition: 'Bom', deadline: ''
            });
            addLog(newId, 'Cadastro', 'Admin', 'Entrada de novo ativo');
        }

        saveData();
        closeModal();
    };

    // Importação CSV
    function importCSV(input) {
        const file = input.files[0];
        if (!file) return;

        const reader = new FileReader();
        reader.onload = function(e) {
            const text = e.target.result;
            const lines = text.split('\n');
            let count = 0;

            // Pula cabeçalho e processa linhas
            for(let i = 1; i < lines.length; i++) {
                const cols = lines[i].split(',').map(c => c.trim());
                if(cols.length >= 3) { // Minimo: Tipo, Modelo, Serie
                    const newId = 'ASSET-' + Math.random().toString(36).substr(2, 9).toUpperCase();
                    assets.push({
                        id: newId,
                        type: cols[0] || 'Desconhecido',
                        model: cols[1] || 'S/M',
                        serial: cols[2] || 'S/N',
                        status: cols[3] || 'Disponível',
                        user: cols[4] || '',
                        condition: 'Bom',
                        deadline: ''
                    });
                    count++;
                }
            }
            addLog('LOTE', 'Importação', 'Admin', Importação de ${count} ativos via CSV);
            saveData();
            input.value = ''; // Limpa input
            alert(${count} ativos importados com sucesso!);
        };
        reader.readAsText(file);
    }

    // Outros Processamentos
    document.getElementById('checkout-form').onsubmit = (e) => {
        e.preventDefault();
        const id = document.getElementById('co-equipment').value;
        const user = document.getElementById('co-user').value;
        const deadline = document.getElementById('co-deadline').value;
        const asset = assets.find(a => a.id === id);
        asset.status = 'Em Uso';
        asset.user = user;
        asset.deadline = deadline;
        addLog(id, 'Checkout', user, Prazo: ${deadline});
        saveData();
        e.target.reset();
    };

    document.getElementById('checkin-form').onsubmit = (e) => {
        e.preventDefault();
        const id = document.getElementById('ci-equipment').value;
        const cond = document.getElementById('ci-condition').value;
        const asset = assets.find(a => a.id === id);
        const oldUser = asset.user;
        asset.status = cond === 'Necessita Reparo' ? 'Manutenção' : 'Disponível';
        asset.user = '';
        asset.deadline = '';
        addLog(id, 'Check-in', oldUser, Condição: ${cond});
        saveData();
        e.target.reset();
    };

    function addLog(assetId, event, agent, notes) {
        logs.push({ date: new Date().toISOString(), assetId, event, agent, notes });
    }

    function deleteAsset(id) {
        if(confirm('Remover este ativo permanentemente?')) {
            assets = assets.filter(a => a.id !== id);
            saveData();
        }
    }

    function populateSelects() {
        const coSel = document.getElementById('co-equipment');
        const ciSel = document.getElementById('ci-equipment');
        coSel.innerHTML = '<option value="">Selecionar Ativo...</option>';
        ciSel.innerHTML = '<option value="">Selecionar Ativo...</option>';
        assets.forEach(a => {
            if(a.status === 'Disponível') coSel.innerHTML += <option value="${a.id}">${a.serial} - ${a.model}</option>;
            else if(a.status === 'Em Uso') ciSel.innerHTML += <option value="${a.id}">${a.user} | ${a.serial}</option>;
        });
    }

    function handleSearch(val) { renderInventory(val); }

    function exportInventory() {
        let csv = "Tipo,Modelo,Serie,Status,Responsavel\n";
        assets.forEach(a => {
            csv += ${a.type},${a.model},${a.serial},${a.status},${a.user || ''}\n;
        });
        const blob = new Blob([csv], { type: 'text/csv' });
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'inventario_ti.csv';
        a.click();
    }
</script>
</body>
</html>
